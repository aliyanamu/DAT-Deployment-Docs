# ================================================================
# NESPAY BACKEND - Environment Configuration
# ================================================================
# Production-ready environment configuration for Nespay backend services
# Copy this file to .env and update with your actual values
# See DOCKER_DEPLOYMENT.md for detailed configuration guide

# ============================================
# CORE APPLICATION CONFIGURATION
# ============================================
NODE_ENV=production
API_PORT=8000
WEBHOOK_PORT=8001
JOB_PORT=8002
PUBLIC_API_PREFIX=api/v1
INTERNAL_API_PREFIX=api/backoffice/v1
ENABLE_CORS_URLS=
BASE_URL=https://api.yourdomain.com

# Mobile App Configuration
APP_SCHEME=nespay

# ============================================
# DATABASE CONFIGURATION
# ============================================
DATABASE_URL=postgresql://nespay_user:yourpassword@localhost:5432/nespay?schema=public

# ============================================
# REDIS CONFIGURATION - Optional Cache
# Application runs in degraded mode without Redis
# ============================================
REDIS_USER=default
REDIS_PASSWORD=
REDIS_ENABLED=false

# Standalone mode
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_DB=0

# Cluster mode
REDIS_CLUSTER_ENABLED=false
REDIS_CLUSTER_NODES=localhost:7001,localhost:7002,localhost:7003
REDIS_CLUSTER_NAT_MAP=node-1:7001=>localhost:7001,node-2:7002=>localhost:7002,node-3:7003=>localhost:7003

# Sentinel mode
REDIS_SENTINEL_ENABLED=false
REDIS_SENTINEL_NAME=mymaster
REDIS_SENTINEL_NODES=localhost:26379,localhost:26380,localhost:26381
REDIS_SENTINEL_NAT_MAP=redis-master:6379=>localhost:6379

# Advanced settings (all optional with sensible defaults)
REDIS_MAX_RETRIES=3
REDIS_RETRY_DELAY=100
REDIS_MAX_RETRY_DELAY=2000
REDIS_READY_CHECK=true
REDIS_OFFLINE_QUEUE=false
REDIS_LAZY_CONNECT=false

# ============================================
# OBSERVABILITY - Logs and Monitoring (Required)
# ============================================
# Loki for log storage
LOKI_URL=http://localhost:3100

# OpenTelemetry - OTLP_LOGS_ENDPOINT points to Grafana Alloy
OTLP_LOGS_ENDPOINT=http://localhost:4318/v1/logs
SERVICE_NAME=nespay-backend
SERVICE_VERSION=1.0.0
ENVIRONMENT=production
CLUSTER_NAME=production

# Job Lock Service Configuration
# Hostname used for job lock identification (falls back to system hostname)
HOSTNAME=
# Alternative hostname environment variable
HOST=

# ================================================================
# PERFORMANCE MONITORING CONFIGURATION
# ================================================================

# === Core Monitoring Settings ===
# Enable/disable all database monitoring (default: false in production, true in dev)
DB_MONITORING_ENABLED=true

# Monitoring level: OFF, ERROR_ONLY, SLOW_ONLY, ALL
DB_MONITORING_LEVEL=ALL

# Sampling rate (0.0 to 1.0) - percentage of queries to monitor
DB_MONITORING_SAMPLING_RATE=1.0

# === Performance Thresholds ===
# Slow query threshold in milliseconds
DB_SLOW_QUERY_THRESHOLD=100

# Slow request threshold in milliseconds
REQUEST_SLOW_THRESHOLD=1000

# === Logging Configuration ===
# Enable async logging (non-blocking)
DB_ASYNC_LOGGING=false

# Maximum query log length in characters
DB_MAX_QUERY_LOG_LENGTH=2000

# === Metrics Storage ===
# Maximum number of metrics entries to keep in memory
DB_MAX_METRICS_ENTRIES=5000

# Metrics retention period in milliseconds (30 minutes)
DB_METRICS_RETENTION_PERIOD=1800000

# === Health Check Settings ===
# Database health check timeout in milliseconds
DB_HEALTH_CHECK_TIMEOUT=10000

# Circuit breaker threshold
DB_CIRCUIT_BREAKER_THRESHOLD=50

# ================================================================
# REQUEST MONITORING CONFIGURATION
# ================================================================

# Enable/disable request performance monitoring
REQUEST_MONITORING_ENABLED=true

# Routes to exclude from monitoring (comma-separated)
REQUEST_EXCLUDED_ROUTES=/health,/metrics,/favicon.ico

# Include request headers in logs
REQUEST_INCLUDE_HEADERS=true

# Include user agent in logs
REQUEST_INCLUDE_USER_AGENT=true

# Add your environment variables here

# BNVK Provider Configuration
BNVK_BASE_URL=https://api.bnvk.example.com
BNVK_API_KEY=mock_api_key
BNVK_API_SECRET=mock_api_secret
BNVK_CALLBACK_URL=https://your-app.example.com/webhooks/bnvk
BNVK_CALLBACK_SECRET=mock_callback_secret
BNVK_TIMEOUT_MS=45000
BNVK_ALLOWED_IPS=127.0.0.1

# Payout sequence number configuration
PAYOUT_DEFAULT_SEQUENCE_NUMBER=1

# Swagger API documentation
SWAGGER_ENABLE=1

# HTTP Client configuration
HTTP_CLIENT_CURL_ONLY_MODE=false

# Access to the health route
HEALTH_TOKEN=

# ============================================
# AUTHENTICATION & AUTHORIZATION
# ============================================
# AWS Cognito - User and admin authentication (Required)
COGNITO_USER_POOL_ID=us-east-1_XXXXXXXXX
COGNITO_USER_CLIENT_ID=xxxxxxxxxxxxxxxxxxxx
COGNITO_ADMIN_POOL_ID=us-east-1_XXXXXXXXX
COGNITO_ADMIN_CLIENT_ID=xxxxxxxxxxxxxxxxxxxx

# Privy - Wallet Management (Required)
PRIVY_APP_ID=
PRIVY_APP_SECRET=
PRIVY_API=https://auth.privy.io

# ============================================
# SECURITY
# ============================================
# Private Key Encryption
# Generate with: openssl rand -hex 64
# Keep this key secure and NEVER commit it to version control
ENCRYPTION_MASTER_KEY=

# Social Providers (Optional)
GOOGLE_CLIENT_ID=
GOOGLE_CLIENT_SECRET=

# Payout Module - Intrajasa
INTRAJASA_BASE_URL=https://api.intraremittance.com/rest/json
INTRAJASA_PARTNER_ID=your_partner_id
INTRAJASA_PARTNER_KEY=your_partner_key
INTRAJASA_CALLBACK_URL=your_callback_url
INTRAJASA_CALLBACK_SECRET=your_callback_secret
INTRAJASA_TIMEOUT_MS=30000
INTRAJASA_ALLOWED_IPS=

# Payout Module - Indodax
INDODAX_BASE_URL=https://api.indodax.com
INDODAX_API_KEY=your_api_key
INDODAX_API_SECRET=your_api_secret
INDODAX_CALLBACK_URL=your_callback_url
INDODAX_CALLBACK_SECRET=your_callback_secret
INDODAX_TIMEOUT_MS=30000
INDODAX_ALLOWED_IPS=127.0.0.1

# Payout Module - General
PAYOUT_RETRY_ATTEMPTS=3
PAYOUT_RETRY_DELAY=1000
PAYOUT_MAX_RETRY_DELAY=10000
PAYOUT_DEFAULT_TIMEOUT=30000
PAYOUT_RATE_LIMIT_WINDOW_MS=60000
PAYOUT_RATE_LIMIT_MAX=10
PAYOUT_ALLOW_INSUFFICIENT_PROVIDER_BALANCE=false

# Payout Notification Configuration
PAYOUT_NOTIFICATION_APP_BASE_URL=https://app.yourdomain.com
PAYOUT_NOTIFICATION_APP_NAME=Nespay
PAYOUT_NOTIFICATION_SUPPORT_EMAIL=support@yourdomain.com

# Email Service Configuration
EMAIL_APP_NAME=Nespay
EMAIL_SUPPORT_EMAIL=support@yourdomain.com
EMAIL_BILLING_EMAIL=billing@yourdomain.com

# ================================================================
# CONSOLIDATION JOB CONFIGURATION
# ================================================================

# Enable/disable the consolidation job (default: false)
CONSOLIDATION_JOB_ENABLED=false

# Cron schedule for consolidation checks (default: every 6 hours)
# Format: "minute hour day month day-of-week"
CONSOLIDATION_JOB_SCHEDULE="0 */6 * * *"

# Filter by specific networks (comma-separated, optional)
# If not set, all networks with active thresholds will be processed
CONSOLIDATION_JOB_NETWORKS=

# Filter by specific accounts (comma-separated, optional)
# If not set, all active accounts will be processed
CONSOLIDATION_JOB_ACCOUNTS=

# Maximum concurrent account processing (default: 3)
CONSOLIDATION_JOB_MAX_CONCURRENT=3

# Job execution timeout in milliseconds (default: 300000 = 5 minutes)
CONSOLIDATION_JOB_TIMEOUT_MS=300000

# Rain.xyz Card Provider Configuration
RAIN_API_URL=https://api-dev.raincards.xyz
RAIN_API_KEY=your_rain_api_key

# EVM Wallet Configuration for Collateral Contract Operations
CARD_ADMIN_EVM_WALLET_ADDRESS=

# Log Storage Configuration
LOG_STORAGE_PRIMARY=database
LOG_STORAGE_SECONDARY=
LOG_STORAGE_ARCHIVE=

# ============================================
# RABBITMQ - Message Queue (Required for invoice callbacks)
# ============================================
RABBITMQ_URL=amqp://nespay_user:yourpassword@localhost:5672/nespay_production

# MOBILE CONFIGURATION
# APP_SCHEME is set above in Mobile App Configuration section

# Nitro Enclave Coordinator Proxy Config
AWS_NITRO_PROXY_URL=http://localhost:3000
AWS_NITRO_PROXY_TIMEOUT=30000
AWS_NITRO_PROXY_API_KEY=your-api-key-here

# ================================================================
# WEBHOOK SECURITY CONFIGURATION
# ================================================================

# === Global Webhook Configuration ===
# These settings apply to all webhook endpoints unless overridden by provider-specific settings

# Webhook IP validation - comma-separated list of allowed IPs/CIDR blocks
# Examples: 192.168.1.1,10.0.0.0/24,203.0.113.5
WEBHOOK_ALLOWED_IPS=

# Enable/disable IP validation for webhook endpoints
WEBHOOK_ENABLE_IP_VALIDATION=true

# Enable/disable signature validation for webhook endpoints
WEBHOOK_ENABLE_SIGNATURE_VALIDATION=true

# Signature tolerance in seconds for webhook validation
WEBHOOK_SIGNATURE_TOLERANCE_SECONDS=300

# === Provider-Specific Webhook IP Configuration ===
# Each provider can have its own allowed IP list and validation settings
# If provider-specific IPs are empty, it will fallback to global WEBHOOK_ALLOWED_IPS

# Rain Cards provider
# Production IP: 34.67.3.60, Sandbox IP: 34.66.230.233
WEBHOOK_RAIN_ALLOWED_IPS=34.67.3.60,34.66.230.233
WEBHOOK_RAIN_ENABLE_IP_VALIDATION=true

# Intrajasa provider
WEBHOOK_INTRAJASA_ALLOWED_IPS=
WEBHOOK_INTRAJASA_ENABLE_IP_VALIDATION=true
# Enable/disable token validation for Intrajasa webhooks (set to false to skip token validation)
WEBHOOK_INTRAJASA_ENABLE_TOKEN_VALIDATION=true
# Expected token value for Intrajasa webhook payload (must match the "token" field in payload)
# Only used when WEBHOOK_INTRAJASA_ENABLE_TOKEN_VALIDATION=true
WEBHOOK_INTRAJASA_TOKEN=3UP1SDc4c2NF4RE5lJDa1dQQTVJ5JDEzJETNhbEJqT3UwcC9Cd3BGNHZkJt4M0JZaTZeLeFdZzRE6ZxV

# BNVK provider
WEBHOOK_BNVK_ALLOWED_IPS=
WEBHOOK_BNVK_ENABLE_IP_VALIDATION=true

# Indodax provider
WEBHOOK_INDODAX_ALLOWED_IPS=
WEBHOOK_INDODAX_ENABLE_IP_VALIDATION=true

# EVM blockchain provider (CryptoAPI)
WEBHOOK_EVM_ALLOWED_IPS=
WEBHOOK_EVM_ENABLE_IP_VALIDATION=true

# Tron blockchain provider (CryptoAPI)
WEBHOOK_TRON_ALLOWED_IPS=
WEBHOOK_TRON_ENABLE_IP_VALIDATION=true

# Solana blockchain provider (CryptoAPI)
WEBHOOK_SOLANA_ALLOWED_IPS=
WEBHOOK_SOLANA_ENABLE_IP_VALIDATION=true

# Sumsub provider
WEBHOOK_SUMSUB_ALLOWED_IPS=
WEBHOOK_SUMSUB_ENABLE_IP_VALIDATION=true

# ITRX provider
WEBHOOK_ITRX_ALLOWED_IPS=
WEBHOOK_ITRX_ENABLE_IP_VALIDATION=true

# Webhook logging configuration
WEBHOOK_ENABLE_DETAILED_LOGGING=true
WEBHOOK_LOG_PAYLOADS=true
WEBHOOK_LOG_HEADERS=true
WEBHOOK_MAX_PAYLOAD_LOG_SIZE=10000

# Webhook rate limiting
WEBHOOK_RATE_LIMIT_WINDOW_MS=60000
WEBHOOK_RATE_LIMIT_MAX=100
WEBHOOK_RATE_LIMIT_SKIP_SUCCESS=false
WEBHOOK_RATE_LIMIT_SKIP_FAILED=false

# Webhook retry configuration
WEBHOOK_RETRY_ATTEMPTS=3
WEBHOOK_RETRY_DELAY=1000
WEBHOOK_MAX_RETRY_DELAY=10000
WEBHOOK_EXPONENTIAL_BACKOFF=true

# Webhook general settings
WEBHOOK_DEFAULT_TIMEOUT=30000
WEBHOOK_MAX_PAYLOAD_SIZE=1048576
WEBHOOK_ENABLE_HEALTH_CHECK=true